!function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.ReconnectingWebSocket=n()}(this,function(){if("WebSocket"in window)return l.prototype.onopen=function(e){},l.prototype.onclose=function(e){},l.prototype.onconnecting=function(e){},l.prototype.onmessage=function(e){},l.prototype.onerror=function(e){},l.debugAll=!1,l.CONNECTING=WebSocket.CONNECTING,l.OPEN=WebSocket.OPEN,l.CLOSING=WebSocket.CLOSING,l.CLOSED=WebSocket.CLOSED,l;function l(e,n,t){var o,c={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};for(o in t=t||{},c)void 0!==t[o]?this[o]=t[o]:this[o]=c[o];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var i,r=this,s=!1,u=!1,a=document.createElement("div");function d(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}a.addEventListener("open",function(e){r.onopen(e)}),a.addEventListener("close",function(e){r.onclose(e)}),a.addEventListener("connecting",function(e){r.onconnecting(e)}),a.addEventListener("message",function(e){r.onmessage(e)}),a.addEventListener("error",function(e){r.onerror(e)}),this.addEventListener=a.addEventListener.bind(a),this.removeEventListener=a.removeEventListener.bind(a),this.dispatchEvent=a.dispatchEvent.bind(a),this.open=function(t){if((i=new WebSocket(r.url,n||[])).binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else a.dispatchEvent(d("connecting")),this.reconnectAttempts=0;(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",r.url);var e=i,o=setTimeout(function(){(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",r.url),u=!0,e.close(),u=!1},r.timeoutInterval);i.onopen=function(e){clearTimeout(o),(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","onopen",r.url),r.protocol=i.protocol,r.readyState=WebSocket.OPEN,r.reconnectAttempts=0;var n=d("open");n.isReconnect=t,t=!1,a.dispatchEvent(n)},i.onclose=function(e){var n;clearTimeout(void 0),i=null,s?(r.readyState=WebSocket.CLOSED,a.dispatchEvent(d("close"))):(r.readyState=WebSocket.CONNECTING,(n=d("connecting")).code=e.code,n.reason=e.reason,n.wasClean=e.wasClean,a.dispatchEvent(n),t||u||((r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","onclose",r.url),a.dispatchEvent(d("close"))),n=r.reconnectInterval*Math.pow(r.reconnectDecay,r.reconnectAttempts),setTimeout(function(){r.reconnectAttempts++,r.open(!0)},n>r.maxReconnectInterval?r.maxReconnectInterval:n))},i.onmessage=function(e){(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",r.url,e.data);var n=d("message");n.data=e.data,a.dispatchEvent(n)},i.onerror=function(e){(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","onerror",r.url,e),a.dispatchEvent(d("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(i)return(r.debug||l.debugAll)&&console.debug("ReconnectingWebSocket","send",r.url,e),i.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,n){void 0===e&&(e=1e3),s=!0,i&&i.close(e,n)},this.refresh=function(){i&&i.close()}}});
